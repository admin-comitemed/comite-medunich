<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma Comit√© Medicina | Gesti√≥n 2025-2026</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <style>
        :root { --primary: #003366; --accent: #d4af37; --bg: #f4f6f9; }
        body { background-color: var(--bg); font-family: 'Segoe UI', sans-serif; }
        
        /* LOGIN VIEW */
        #login-view { height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, var(--primary) 0%, #001f3f 100%); }
        .login-card { background: white; padding: 2rem; border-radius: 15px; width: 100%; max-width: 400px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        
        /* APP VIEW */
        #app-view { display: none; } /* Oculto por defecto */
        .navbar-custom { background-color: var(--primary); }
        .student-card { background: linear-gradient(to right, #003366, #004080); color: white; border-radius: 15px; padding: 20px; }
    </style>
</head>
<body>

    <div id="login-view">
        <div class="login-card animate__animated animate__fadeInUp">
            <div class="text-center mb-4">
                <i class="fas fa-hospital-user fa-3x text-primary mb-2"></i>
                <h4 class="fw-bold">Acceso Estudiantes</h4>
                <p class="text-muted small">Comit√© M√©dico Cirujano 2025-2026</p>
            </div>

            <form id="formLogin" onsubmit="event.preventDefault(); login();">
                <div class="mb-3">
                    <input type="email" id="email" class="form-control" placeholder="Correo electr√≥nico" required>
                </div>
                <div class="mb-3">
                    <input type="password" id="password" class="form-control" placeholder="Contrase√±a" required>
                </div>
                <button type="submit" class="btn btn-primary w-100 fw-bold">Entrar</button>
                <div class="text-center mt-3">
                    <a href="#" onclick="toggleRegister()" class="small text-decoration-none">¬øNuevo ingreso? Reg√≠strate aqu√≠</a>
                </div>
            </form>

            <form id="formRegister" style="display:none;" onsubmit="event.preventDefault(); registrar();">
                <div class="mb-2"><input type="text" id="regName" class="form-control" placeholder="Nombre Completo" required></div>
                <div class="mb-2">
                    <select id="regSemestre" class="form-select" required>
                        <option value="" selected disabled>Selecciona tu Semestre</option>
                        <option value="1">1er Semestre</option>
                        <option value="2">2do Semestre</option>
                        <option value="3">3er Semestre</option>
                        <option value="4">4to Semestre</option>
                        <option value="5">5to Semestre</option>
                        <option value="6">6to Semestre</option>
                        <option value="7">7mo Semestre</option>
                        <option value="8">8vo Semestre (Pediatr√≠a)</option>
                        <option value="9">Internado</option>
                    </select>
                </div>
                <div class="mb-2"><input type="email" id="regEmail" class="form-control" placeholder="Correo electr√≥nico" required></div>
                <div class="mb-3"><input type="password" id="regPass" class="form-control" placeholder="Crear Contrase√±a" required></div>
                <button type="submit" class="btn btn-success w-100 fw-bold">Registrarme</button>
                <div class="text-center mt-3">
                    <a href="#" onclick="toggleRegister()" class="small text-decoration-none text-muted">Volver al Login</a>
                </div>
            </form>
            <div id="loginError" class="alert alert-danger mt-3 small d-none"></div>
        </div>
    </div>

    <div id="app-view">
        <nav class="navbar navbar-dark navbar-custom mb-4">
            <div class="container">
                <a class="navbar-brand fw-bold" href="#"><i class="fas fa-user-md me-2"></i>Comit√© UNICH</a>
                <div class="d-flex">
                    <button class="btn btn-sm btn-info text-dark me-2 fw-bold" onclick="abrirIA()"><i class="fas fa-brain me-1"></i>Dr. Evidence</button>
                    <button class="btn btn-sm btn-outline-light" onclick="logout()">Salir <i class="fas fa-sign-out-alt"></i></button>
                </div>
            </div>
        </nav>

        <div class="container">
            <div class="student-card mb-4 shadow animate__animated animate__fadeIn">
                <div class="d-flex align-items-center">
                    <div class="bg-white text-primary rounded-circle p-3 me-3 display-6"><i class="fas fa-user-graduate"></i></div>
                    <div>
                        <h6 class="text-warning text-uppercase mb-0 small fw-bold">Expediente Acad√©mico</h6>
                        <h2 class="fw-bold mb-0" id="userNameDisplay">Cargando...</h2>
                        <span class="badge bg-light text-dark mt-2" id="userSemestreDisplay">...</span>
                    </div>
                </div>
            </div>

            <ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
                <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#biblioteca">üìö Biblioteca</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#apuntes">üìù Mis Apuntes</button></li>
            </ul>

            <div class="tab-content">
                <div class="tab-pane fade show active" id="biblioteca">
                    <div class="alert alert-info border-0 shadow-sm">
                        <i class="fas fa-info-circle me-2"></i> Accede a los libros esenciales de la carrera.
                    </div>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="card p-3 h-100 shadow-sm border-0">
                                <h6 class="fw-bold">Nelson. Tratado de Pediatr√≠a</h6>
                                <p class="small text-muted">La biblia de la pediatr√≠a. Edici√≥n 21.</p>
                                <button class="btn btn-sm btn-outline-primary mt-auto">Ver Recurso</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="apuntes">
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-cloud-upload-alt fa-3x mb-3"></i>
                        <h5>Tus aportes acad√©micos</h5>
                        <p>Pr√≥ximamente podr√°s subir tus res√∫menes aqu√≠.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="iaModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title"><i class="fas fa-user-md me-2 text-info"></i>Dr. Evidence</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body bg-light">
                    <div id="chatHistory" class="p-3 mb-3 bg-white rounded shadow-sm" style="height: 300px; overflow-y: auto;">
                        <div class="text-muted small text-center mt-2">Sistemas listos. Pregunta sobre casos cl√≠nicos o temas de estudio.</div>
                    </div>
                    <div class="input-group">
                        <input type="text" id="iaQuery" class="form-control" placeholder="Escribe tu consulta..." onkeypress="if(event.key === 'Enter') consultarIA()">
                        <button class="btn btn-dark" onclick="consultarIA()"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // TU CONFIGURACI√ìN
        const firebaseConfig = {
            apiKey: "AIzaSyBxl7NFNI8lxfmdC-YJYmZ21zQOxQ72-3U",
            authDomain: "centro-de-recursos-academicos.firebaseapp.com",
            projectId: "centro-de-recursos-academicos",
            storageBucket: "centro-de-recursos-academicos.firebasestorage.app",
            messagingSenderId: "799558207054",
            appId: "1:799558207054:web:c7bb8f1400a4f2181ee51f",
            measurementId: "G-GWC94WNY9F"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- MANEJO DE VISTAS ---
        const loginView = document.getElementById('login-view');
        const appView = document.getElementById('app-view');

        // MONITOR DE ESTADO (¬øEst√° logueado?)
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // SI hay usuario
                loginView.style.display = 'none';
                appView.style.display = 'block';
                await cargarPerfil(user.uid);
            } else {
                // NO hay usuario
                loginView.style.display = 'flex';
                appView.style.display = 'none';
            }
        });

        // --- FUNCIONES DE AUTENTICACI√ìN GLOBAL ---
        window.toggleRegister = () => {
            const formLogin = document.getElementById('formLogin');
            const formRegister = document.getElementById('formRegister');
            if(formLogin.style.display === 'none') {
                formLogin.style.display = 'block';
                formRegister.style.display = 'none';
            } else {
                formLogin.style.display = 'none';
                formRegister.style.display = 'block';
            }
        };

        window.registrar = async () => {
            const email = document.getElementById('regEmail').value;
            const pass = document.getElementById('regPass').value;
            const nombre = document.getElementById('regName').value;
            const semestre = document.getElementById('regSemestre').value;
            const errorDiv = document.getElementById('loginError');

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
                const user = userCredential.user;
                
                // Guardar datos extra en Firestore
                await setDoc(doc(db, "estudiantes", user.uid), {
                    nombre: nombre,
                    semestre: semestre,
                    email: email,
                    rol: "estudiante"
                });
                
                errorDiv.classList.add('d-none');
            } catch (error) {
                console.error(error);
                errorDiv.textContent = "Error: " + error.message;
                errorDiv.classList.remove('d-none');
            }
        };

        window.login = async () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');

            try {
                await signInWithEmailAndPassword(auth, email, pass);
                errorDiv.classList.add('d-none');
            } catch (error) {
                errorDiv.textContent = "Credenciales incorrectas.";
                errorDiv.classList.remove('d-none');
            }
        };

        window.logout = () => signOut(auth);

        async function cargarPerfil(uid) {
            const docRef = doc(db, "estudiantes", uid);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById('userNameDisplay').textContent = "Dr(a). " + data.nombre;
                document.getElementById('userSemestreDisplay').textContent = data.semestre + "¬∞ Semestre";
            } else {
                document.getElementById('userNameDisplay').textContent = "Bienvenido";
            }
        }
    </script>

    <script>
        const GROQ_API_KEY = "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"; 
        
        function abrirIA() { new bootstrap.Modal(document.getElementById('iaModal')).show(); }

        async function consultarIA() {
            const input = document.getElementById('iaQuery');
            const chatBox = document.getElementById('chatHistory');
            const pregunta = input.value.trim();
            if(!pregunta) return;

            chatBox.innerHTML += `<div class="text-end mb-2"><span class="bg-primary text-white p-2 rounded">${pregunta}</span></div>`;
            input.value = '';

            // Loading
            const loadId = "load"+Date.now();
            chatBox.innerHTML += `<div id="${loadId}" class="text-muted small"><i class="fas fa-spinner fa-spin"></i> Analizando evidencia...</div>`;
            chatBox.scrollTop = chatBox.scrollHeight;

            try {
                const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${GROQ_API_KEY}` },
                    body: JSON.stringify({
                        model: "openai/gpt-oss-120b", // El modelo solicitado
                        messages: [
                            { role: "system", content: "Eres Dr. Evidence, un asistente m√©dico acad√©mico experto. S√© conciso y cita fuentes si es posible." },
                            { role: "user", content: pregunta }
                        ]
                    })
                });
                const data = await response.json();
                document.getElementById(loadId).remove();
                
                if(data.choices) {
                    const txt = data.choices[0].message.content.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
                    chatBox.innerHTML += `<div class="text-start mb-2"><div class="bg-light p-2 rounded border">${txt}</div></div>`;
                }
            } catch(e) {
                document.getElementById(loadId).innerHTML = "Error de conexi√≥n.";
            }
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
