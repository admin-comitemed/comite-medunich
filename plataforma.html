<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma Estudiantil | Comit√© Medicina</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #003366; --secondary: #8A1538; --accent: #D4AF37; --bg: #f4f6f9; }
        body { background-color: var(--bg); font-family: 'Lato', sans-serif; color: #333; }
        h1, h2, h3, h4, h5, h6 { font-family: 'Montserrat', sans-serif; }
        
        #login-view { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, var(--primary) 0%, #001f3f 100%); padding: 20px; }
        .login-card { background: white; padding: 2.5rem; border-radius: 15px; width: 100%; max-width: 450px; box-shadow: 0 15px 35px rgba(0,0,0,0.3); border-top: 5px solid var(--accent); }
        #app-view { display: none; }
        .navbar-custom { background-color: var(--primary); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .student-card { background: linear-gradient(to right, var(--primary), #004080); color: white; border-radius: 15px; padding: 25px; border-left: 5px solid var(--accent); }
        .nav-tabs .nav-link { color: #555; font-weight: 600; border: none; transition: 0.3s; }
        .nav-tabs .nav-link.active { color: var(--primary); border-bottom: 3px solid var(--primary); background: transparent; }
        .tool-card { transition: transform 0.2s; border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .tool-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-color: var(--accent) !important; }
        .quiz-card { background: linear-gradient(45deg, var(--secondary), #a31e45); color: white; }
        .quiz-option { cursor: pointer; background: rgba(255,255,255,0.15); padding: 10px; margin-bottom: 8px; border-radius: 6px; transition: 0.2s; border: 1px solid rgba(255,255,255,0.1); font-size: 0.9rem; }
        .quiz-option:hover { background: rgba(255,255,255,0.3); transform: translateX(5px); }
        .buzon-card { border: 2px dashed var(--primary); background-color: #f8fbff; }
        .fav-book-item { background: white; border-radius: 8px; padding: 12px; border-left: 4px solid var(--accent); box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: 0.2s; margin-bottom: 10px; }
        .fav-book-item:hover { transform: translateX(5px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        
        .cat-header { background: linear-gradient(90deg, var(--primary) 0%, #004a99 100%); color: white !important; font-weight: 800; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; padding: 10px 15px; border-radius: 4px; }
        tr.sep-row td { padding-top: 15px !important; border: none; }
        
        /* Modal & Accordion Styles */
        .modal-header { background-color: var(--primary); color: white; }
        .modal-title { font-weight: bold; font-family: 'Montserrat', sans-serif; }
        .btn-close-white { filter: invert(1) grayscale(100%) brightness(200%); }
        .result-box { background: #e8f4fd; border-left: 5px solid var(--primary); padding: 15px; margin-top: 15px; font-weight: bold; border-radius: 5px; text-align: center; }
        
        .accordion-button { padding: 10px 15px; font-size: 0.9rem; font-weight: bold; color: var(--primary); background-color: #f8f9fa; }
        .accordion-button:not(.collapsed) { color: white; background-color: var(--primary); box-shadow: none; }
        .accordion-body { padding: 10px; font-size: 0.85rem; background-color: #fff; }
        .plant-item { border-bottom: 1px dashed #eee; padding: 8px 0; }
        .plant-item:last-child { border-bottom: none; }

        footer { background-color: var(--primary); color: white; padding: 3rem 0; font-size: 0.85rem; border-top: 5px solid var(--accent); }
        .hover-link:hover { color: var(--accent) !important; text-decoration: underline !important; }

        /* Chat IA Styles */
        .chat-msg-user { text-align: right; margin-bottom: 10px; }
        .chat-msg-user span { background-color: var(--primary); color: white; padding: 8px 12px; border-radius: 15px 15px 0 15px; display: inline-block; }
        .chat-msg-ai { text-align: left; margin-bottom: 10px; }
        .chat-msg-ai div { background-color: #f1f3f5; padding: 10px 15px; border-radius: 15px 15px 15px 0; display: inline-block; border: 1px solid #dee2e6; }
    </style>
</head>
<body>

    <div id="login-view">
        <div class="login-card animate__animated animate__fadeInUp">
            <div class="text-center mb-4">
                <i class="fas fa-user-md fa-4x text-primary mb-3"></i>
                <h3 class="fw-bold text-dark">Acceso Alumnos</h3>
                <p class="text-muted small">Plataforma Comit√© M√©dico Cirujano</p>
            </div>
            <form id="formLogin" onsubmit="event.preventDefault(); login();">
                <div class="form-floating mb-3"><input type="email" id="email" class="form-control" placeholder="Email" required><label>Correo Institucional</label></div>
                <div class="form-floating mb-3"><input type="password" id="password" class="form-control" placeholder="Contrase√±a" required><label>Contrase√±a</label></div>
                <button type="submit" class="btn btn-primary w-100 py-2 fw-bold mb-3" style="background-color: var(--primary);">INGRESAR</button>
                <div class="d-flex justify-content-between align-items-center mt-4">
                    <a href="index.html" class="text-decoration-none small text-muted"><i class="fas fa-arrow-left me-1"></i> Volver al Lobby</a>
                    <a href="#" onclick="toggleRegister()" class="text-decoration-none small fw-bold text-primary">Crear cuenta</a>
                </div>
            </form>
            <form id="formRegister" style="display:none;" onsubmit="event.preventDefault(); registrar();">
                <h5 class="fw-bold mb-3 text-center text-primary">Registro Nuevo Ingreso</h5>
                <div class="mb-2"><input type="text" id="regName" class="form-control" placeholder="Nombre Completo" required></div>
                <div class="mb-2">
                    <select id="regSemestre" class="form-select" required>
                        <option value="" disabled selected>Grado</option>
                        <option value="1">1¬∞</option><option value="2">2¬∞</option><option value="3">3¬∞</option><option value="4">4¬∞</option><option value="5">5¬∞</option>
                        <option value="6">6¬∞</option><option value="7">7¬∞</option><option value="8">8¬∞</option><option value="9">9¬∞</option><option value="10">10¬∞</option>
                        <option value="Internado">Internado</option><option value="Servicio">Servicio Social</option>
                    </select>
                </div>
                <div class="mb-2"><input type="email" id="regEmail" class="form-control" placeholder="Correo" required></div>
                <div class="mb-3"><input type="password" id="regPass" class="form-control" placeholder="Contrase√±a" required></div>
                <button type="submit" class="btn btn-success w-100 fw-bold">REGISTRARME</button>
                <div class="text-center mt-3"><a href="#" onclick="toggleRegister()" class="small text-muted">Cancelar</a></div>
            </form>
            <div id="loginError" class="alert alert-danger mt-3 small d-none text-center"></div>
        </div>
    </div>

    <div id="app-view">
        <nav class="navbar navbar-dark navbar-custom mb-4 sticky-top">
            <div class="container">
                <a class="navbar-brand fw-bold d-flex align-items-center" href="#"><i class="fas fa-laptop-medical me-2"></i><div>Plataforma Estudiantil<br><span class="small fw-normal" style="font-size: 0.65rem; opacity: 0.8;">Construida por Comit√© M√©dico Cirujano UNICH 2025 - 2026</span></div></a>
                <div class="d-flex align-items-center">
                    <button class="btn btn-sm btn-light text-primary me-2 fw-bold rounded-pill px-3" onclick="abrirIA()"><i class="fas fa-brain me-1"></i>Dr. Evidence</button>
                    <button class="btn btn-sm btn-outline-light" onclick="logout()" title="Cerrar Sesi√≥n"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </div>
        </nav>

        <div class="container pb-5">
            <div class="student-card mb-4 shadow animate__animated animate__fadeIn">
                <div class="d-flex align-items-center position-relative" style="z-index: 2;">
                    <div class="bg-white text-primary rounded-circle p-3 me-3"><i class="fas fa-user-graduate fa-2x"></i></div>
                    <div>
                        <h6 class="text-warning text-uppercase mb-0 small fw-bold">Bienvenido(a) Colega</h6>
                        <h2 class="fw-bold mb-0" id="userNameDisplay">Cargando...</h2>
                        <span class="badge bg-light text-dark mt-2" id="userSemestreDisplay">...</span>
                    </div>
                </div>
            </div>

            <ul class="nav nav-tabs nav-justified mb-4" id="myTab" role="tablist">
                <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-biblio"><i class="fas fa-book me-2"></i>Recursos</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-clinica"><i class="fas fa-briefcase-medical me-2"></i>Herramientas</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-inter"><i class="fas fa-language me-2"></i>Intercultural</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-buzon"><i class="fas fa-envelope-open-text me-2"></i>Buz√≥n</button></li>
            </ul>

            <div class="tab-content">
                
                <div class="tab-pane fade show active" id="tab-biblio">
                    <div class="row align-items-center mb-4">
                        <div class="col-md-8">
                            <h4 class="fw-bold text-primary">Biblioteca Digital</h4>
                            <p class="text-muted">Accede a todos los libros y gu√≠as organizados.</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <a href="libros_privado.html" class="btn btn-warning fw-bold w-100 shadow-sm text-dark"><i class="fas fa-external-link-alt me-2"></i>IR A LA BIBLIOTECA</a>
                        </div>
                    </div>

                    <h5 class="mb-3 border-bottom pb-2"><i class="fas fa-star text-warning me-2"></i>Mis Libros Favoritos (Nube)</h5>
                    <div id="favoritos-container" class="row g-2 mb-4">
                        <div class="col-12 text-center py-5">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="small text-muted mt-2">Sincronizando con la nube...</p>
                        </div>
                    </div>

                    <h5 class="mb-3 border-bottom pb-2 mt-4"><i class="fas fa-file-contract text-secondary me-2"></i>Formatos Oficiales</h5>
                    <div class="list-group">
                        <a href="https://docs.google.com/spreadsheets/d/1vCLqPCWejpWCRKa_DHXNarKFwZhmFv93/edit?usp=sharing&ouid=111314461129843481710&rtpof=true&sd=true" target="_blank" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <div><i class="fas fa-file-excel text-success me-2"></i>Formato Solicitud CUID</div>
                            <span class="badge bg-light text-dark"><i class="fas fa-download"></i></span>
                        </a>
                        <a href="https://drive.google.com/file/d/1_qyhYlrZ53I71mLZiJcV-ZtI7TV-qlBP/view?usp=sharing" target="_blank" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <div><i class="fas fa-file-image text-primary me-2"></i>Logo Licenciatura</div>
                            <span class="badge bg-light text-dark"><i class="fas fa-download"></i></span>
                        </a>
                        <a href="https://drive.google.com/file/d/1uc-L85dd3n4qHQh0Iw3BdEbql-C5jSt5/view?usp=sharing" target="_blank" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <div><i class="fas fa-university text-secondary me-2"></i>Logo Universidad</div>
                            <span class="badge bg-light text-dark"><i class="fas fa-download"></i></span>
                        </a>
                    </div>
                </div>

                <div class="tab-pane fade" id="tab-clinica">
                    <div class="row g-4">
                        
                        <div class="col-md-12">
                            <div class="card p-4 shadow-sm border-0 tool-card">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="fw-bold text-primary m-0"><i class="fas fa-calculator me-2"></i>Calculadora M√©dica</h5>
                                    <span class="badge bg-light text-muted border">v1.0</span>
                                </div>
                                <div class="row g-3 align-items-end mb-4">
                                    <div class="col-md-4">
                                        <label class="fw-bold small text-muted">1. Peso (kg)</label>
                                        <input type="number" id="pesoCalc" class="form-control form-control-lg border-primary" placeholder="Ej: 20">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="fw-bold small text-muted">2. Paciente</label>
                                        <select id="tipoPaciente" class="form-select form-select-lg border-primary fw-bold text-primary">
                                            <option value="ped" selected>üë∂ Pedi√°trico</option>
                                            <option value="adu">üë§ Adulto / General</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <button class="btn btn-primary w-100 btn-lg fw-bold" onclick="calcularTodo()"><i class="fas fa-bolt me-2"></i>CALCULAR</button>
                                    </div>
                                </div>
                                <div id="resultadosDosis" style="display:none;">
                                    <div id="listaPediatria" style="display:none;">
                                        <div class="table-responsive">
                                            <table class="table table-hover table-sm border-bottom align-middle">
                                                <thead class="table-light"><tr><th>F√°rmaco</th><th class="text-end">Dosis Calc.</th></tr></thead>
                                                <tbody>
                                                    <tr class="sep-row"><td colspan="2" class="cat-header"><i class="fas fa-thermometer-half me-2"></i>Analgesia y Fiebre</td></tr>
                                                    <tr><td><strong>Paracetamol</strong><br><small class="text-muted">(10-15 mg/kg ‚Ä¢ c/6h)</small></td><td class="text-end"><span class="badge bg-success fs-6" id="pedPara">...</span></td></tr>
                                                    <tr><td><strong>Ibuprofeno</strong><br><small class="text-muted">(10 mg/kg ‚Ä¢ c/8h)</small></td><td class="text-end"><span class="badge bg-success fs-6" id="pedIbu">...</span></td></tr>
                                                    <tr><td><strong>Metamizol</strong><br><small class="text-muted">(10-15 mg/kg ‚Ä¢ c/6-8h)</small></td><td class="text-end"><span class="badge bg-success fs-6" id="pedMeta">...</span></td></tr>
                                                    <tr class="sep-row"><td colspan="2" class="cat-header"><i class="fas fa-bacteria me-2"></i>Antibi√≥ticos</td></tr>
                                                    <tr><td><strong>Amoxicilina</strong><br><small class="text-muted">(50 mg/kg/d√≠a √∑ 3)</small></td><td class="text-end"><span class="badge bg-primary fs-6" id="pedAmox">...</span></td></tr>
                                                    <tr><td><strong>Ceftriaxona</strong><br><small class="text-muted">(50 mg/kg/d√≠a √∑ 2)</small></td><td class="text-end"><span class="badge bg-primary fs-6" id="pedCeft">...</span></td></tr>
                                                    <tr><td><strong>TMP/SMX</strong><br><small class="text-muted">(8 mg/kg/d√≠a TMP √∑ 2)</small></td><td class="text-end"><span class="badge bg-primary fs-6" id="pedTmp">...</span></td></tr>
                                                    <tr><td><strong>Azitromicina</strong><br><small class="text-muted">(10 mg/kg/d√≠a ‚Ä¢ 24h)</small></td><td class="text-end"><span class="badge bg-primary fs-6" id="pedAzit">...</span></td></tr>
                                                    <tr><td><strong>Cefalexina</strong><br><small class="text-muted">(50 mg/kg/d√≠a √∑ 4)</small></td><td class="text-end"><span class="badge bg-primary fs-6" id="pedCefa">...</span></td></tr>
                                                    <tr class="sep-row"><td colspan="2" class="cat-header"><i class="fas fa-lungs me-2"></i>Respiratorio y Alergia</td></tr>
                                                    <tr><td><strong>Salbutamol (Jbe)</strong><br><small class="text-muted">(0.1 mg/kg ‚Ä¢ c/8h)</small></td><td class="text-end"><span class="badge bg-warning text-dark fs-6" id="pedSalb">...</span></td></tr>
                                                    <tr><td><strong>Ambroxol</strong><br><small class="text-muted">(1.5 mg/kg/d√≠a √∑ 3)</small></td><td class="text-end"><span class="badge bg-warning text-dark fs-6" id="pedAmbr">...</span></td></tr>
                                                    <tr><td><strong>Loratadina</strong><br><small class="text-muted">(<30kg:5mg ‚Ä¢ >30kg:10mg)</small></td><td class="text-end"><span class="badge bg-secondary fs-6" id="pedLora">...</span></td></tr>
                                                    <tr><td><strong>Cetirizina</strong><br><small class="text-muted">(0.25 mg/kg/d√≠a)</small></td><td class="text-end"><span class="badge bg-secondary fs-6" id="pedCeti">...</span></td></tr>
                                                    <tr><td><strong>Prednisona</strong><br><small class="text-muted">(1 mg/kg/d√≠a ‚Ä¢ Crisis)</small></td><td class="text-end"><span class="badge bg-info text-dark fs-6" id="pedPred">...</span></td></tr>
                                                    <tr><td><strong>Dexametasona</strong><br><small class="text-muted">(0.6 mg/kg ‚Ä¢ Max 16)</small></td><td class="text-end"><span class="badge bg-info text-dark fs-6" id="pedDexa">...</span></td></tr>
                                                    <tr class="sep-row"><td colspan="2" class="cat-header"><i class="fas fa-ambulance me-2"></i>Urgencias y Gastro</td></tr>
                                                    <tr><td><strong>Adrenalina (IM)</strong><br><small class="text-muted">(0.01 mg/kg ‚Ä¢ Max 0.3)</small></td><td class="text-end"><span class="badge bg-danger fs-6" id="pedAdre">...</span></td></tr>
                                                    <tr><td><strong>Hidrocortisona (IV)</strong><br><small class="text-muted">(5 mg/kg/dosis ‚Ä¢ Crisis)</small></td><td class="text-end"><span class="badge bg-danger fs-6" id="pedHidro">...</span></td></tr>
                                                    <tr><td><strong>Diazepam (IV)</strong><br><small class="text-muted">(0.3 mg/kg ‚Ä¢ Crisis)</small></td><td class="text-end"><span class="badge bg-danger fs-6" id="pedDiaz">...</span></td></tr>
                                                    <tr><td><strong>Midazolam</strong><br><small class="text-muted">(0.15 mg/kg ‚Ä¢ Sedaci√≥n)</small></td><td class="text-end"><span class="badge bg-danger fs-6" id="pedMida">...</span></td></tr>
                                                    <tr><td><strong>Ondansetr√≥n</strong><br><small class="text-muted">(0.15 mg/kg ‚Ä¢ c/8h)</small></td><td class="text-end"><span class="badge bg-info text-dark fs-6" id="pedOnda">...</span></td></tr>
                                                    <tr><td><strong>Metoclopramida</strong><br><small class="text-muted">(0.15 mg/kg ‚Ä¢ c/8h)</small></td><td class="text-end"><span class="badge bg-info text-dark fs-6" id="pedMeto">...</span></td></tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div id="listaAdultos" style="display:none;">
                                        <div class="table-responsive">
                                            <table class="table table-hover table-sm border-bottom align-middle">
                                                <thead class="table-light"><tr><th>F√°rmaco</th><th class="text-end">Dosis / Resultado</th></tr></thead>
                                                <tbody>
                                                    <tr class="sep-row"><td colspan="2" class="cat-header"><i class="fas fa-calculator me-2"></i>C√°lculos por Peso</td></tr>
                                                    <tr class="table-primary"><td><strong>üíß L√≠quidos Basales</strong><br><small class="text-muted">(35 ml/kg/d√≠a)</small></td><td class="text-end"><span class="badge bg-primary fs-6" id="aduLiq">...</span></td></tr>
                                                    <tr class="table-warning"><td><strong>üíâ Insulina (TDD)</strong><br><small class="text-muted">(0.5 UI/kg/d√≠a)</small></td><td class="text-end"><span class="badge bg-warning text-dark fs-6" id="aduIns">...</span></td></tr>
                                                    <tr class="table-secondary"><td><strong>üíä Tramadol</strong><br><small class="text-muted">(1 mg/kg/dosis)</small></td><td class="text-end"><span class="badge bg-secondary fs-6" id="aduTram">...</span></td></tr>
                                                    <tr class="table-secondary"><td><strong>üíä Enoxaparina</strong><br><small class="text-muted">(1 mg/kg/dosis Tx)</small></td><td class="text-end"><span class="badge bg-secondary fs-6" id="aduEnox">...</span></td></tr>
                                                    <tr class="sep-row"><td colspan="2" class="cat-header"><i class="fas fa-heartbeat me-2"></i>Cr√≥nicos y Metab√≥licos</td></tr>
                                                    <tr><td><strong>Metformina</strong><br><small class="text-muted">(C/12-24h ‚Ä¢ Inicial)</small></td><td class="text-end fw-bold">850 mg</td></tr>
                                                    <tr><td><strong>Losart√°n</strong><br><small class="text-muted">(C/12-24h)</small></td><td class="text-end fw-bold">50 mg</td></tr>
                                                    <tr><td><strong>Enalapril</strong><br><small class="text-muted">(C/12h)</small></td><td class="text-end fw-bold">10 mg</td></tr>
                                                    <tr><td><strong>Amlodipino</strong><br><small class="text-muted">(C/24h)</small></td><td class="text-end fw-bold">5 mg</td></tr>
                                                    <tr><td><strong>Atorvastatina</strong><br><small class="text-muted">(C/24h ‚Ä¢ Noche)</small></td><td class="text-end fw-bold">20-40 mg</td></tr>
                                                    <tr><td><strong>Aspirina (AAS)</strong><br><small class="text-muted">(Protecci√≥n IAM)</small></td><td class="text-end fw-bold">100 mg</td></tr>
                                                    <tr class="sep-row"><td colspan="2" class="cat-header"><i class="fas fa-pills me-2"></i>Analgesia</td></tr>
                                                    <tr><td><strong>Paracetamol</strong><br><small class="text-muted">(C/8h ‚Ä¢ Max 4g)</small></td><td class="text-end fw-bold">500 mg</td></tr>
                                                    <tr><td><strong>Ketorolaco</strong><br><small class="text-muted">(C/8h ‚Ä¢ Max 5 d√≠as)</small></td><td class="text-end fw-bold">30 mg</td></tr>
                                                    <tr><td><strong>Diclofenaco</strong><br><small class="text-muted">(C/12h ‚Ä¢ IM)</small></td><td class="text-end fw-bold">75 mg</td></tr>
                                                    <tr><td><strong>Naproxeno</strong><br><small class="text-muted">(C/12h)</small></td><td class="text-end fw-bold">250-500 mg</td></tr>
                                                    <tr><td><strong>Butilhioscina</strong><br><small class="text-muted">(C/8h ‚Ä¢ C√≥lico)</small></td><td class="text-end fw-bold">10-20 mg</td></tr>
                                                    <tr class="sep-row"><td colspan="2" class="cat-header"><i class="fas fa-medkit me-2"></i>Antibi√≥ticos y Otros</td></tr>
                                                    <tr><td><strong>Ceftriaxona</strong><br><small class="text-muted">(C/12-24h ‚Ä¢ IV)</small></td><td class="text-end fw-bold">1-2 g</td></tr>
                                                    <tr><td><strong>Ciprofloxacino</strong><br><small class="text-muted">(C/12h)</small></td><td class="text-end fw-bold">500 mg</td></tr>
                                                    <tr><td><strong>Amikacina</strong><br><small class="text-muted">(C/24h ‚Ä¢ IM)</small></td><td class="text-end fw-bold">1 g (Standard)</td></tr>
                                                    <tr><td><strong>Omeprazol</strong><br><small class="text-muted">(C/24h ‚Ä¢ Ayuno)</small></td><td class="text-end fw-bold">20-40 mg</td></tr>
                                                    <tr><td><strong>Metoclopramida</strong><br><small class="text-muted">(C/8h)</small></td><td class="text-end fw-bold">10 mg</td></tr>
                                                    <tr><td><strong>Salbutamol</strong><br><small class="text-muted">(Rescate)</small></td><td class="text-end fw-bold">2 Disparos</td></tr>
                                                    <tr><td><strong>Clorfenamina</strong><br><small class="text-muted">(C/8h)</small></td><td class="text-end fw-bold">4 mg</td></tr>
                                                    <tr><td><strong>Furosemida</strong><br><small class="text-muted">(C/12-24h)</small></td><td class="text-end fw-bold">20-40 mg</td></tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-12">
                            <div class="card quiz-card shadow border-0 p-3 h-100">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="fw-bold m-0"><i class="fas fa-fire me-2"></i>Reto ENARM del D√≠a</h6>
                                    <button class="btn btn-sm btn-light py-0 fw-bold border-0" style="font-size:0.75rem; background: rgba(255,255,255,0.2); color:white;" onclick="cargarReto()">üîÑ Otra</button>
                                </div>
                                <div id="quizContainer"></div>
                            </div>
                        </div>
                        
                        <div class="col-md-12">
                            <div class="card p-3 shadow-sm border-0 tool-card">
                                <h6 class="fw-bold text-dark mb-3"><i class="fas fa-ruler-combined me-2"></i>Escalas de Guardia (Interactivas)</h6>
                                <div class="row g-2">
                                    <div class="col-md-3 col-6">
                                        <button class="btn btn-outline-primary w-100 py-3 fw-bold" data-bs-toggle="modal" data-bs-target="#modalGlasgow">
                                            <i class="fas fa-brain fa-2x mb-2 d-block"></i>Glasgow
                                        </button>
                                    </div>
                                    <div class="col-md-3 col-6">
                                        <button class="btn btn-outline-success w-100 py-3 fw-bold" data-bs-toggle="modal" data-bs-target="#modalSilverman">
                                            <i class="fas fa-baby fa-2x mb-2 d-block"></i>Silverman
                                        </button>
                                    </div>
                                    <div class="col-md-3 col-6">
                                        <button class="btn btn-outline-danger w-100 py-3 fw-bold" data-bs-toggle="modal" data-bs-target="#modalAlvarado">
                                            <i class="fas fa-user-md fa-2x mb-2 d-block"></i>Alvarado
                                        </button>
                                    </div>
                                    <div class="col-md-3 col-6">
                                        <button class="btn btn-outline-warning text-dark w-100 py-3 fw-bold" data-bs-toggle="modal" data-bs-target="#modalObstetrica">
                                            <i class="fas fa-female fa-2x mb-2 d-block"></i>FPP / SDG
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <div class="tab-pane fade" id="tab-inter">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="card p-3 shadow-sm border-0 h-100 tool-card">
                                <h6 class="fw-bold text-primary">Auxiliar Tsotsil</h6>
                                <select id="fraseSelect" class="form-select mb-3" onchange="traducir()">
                                    <option value="" selected>Frase...</option>
                                    <option value="1">Buenos d√≠as</option><option value="2">¬øD√≥nde duele?</option>
                                </select>
                                <div class="alert alert-primary text-center fw-bold text-dark" id="traduccionBox">...</div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="card p-3 shadow-sm border-0 h-100 tool-card">
                                <h6 class="fw-bold text-success">Auxiliar Tseltal</h6>
                                <select id="fraseSelectTseltal" class="form-select mb-3" onchange="traducirTseltal()">
                                    <option value="" selected>Frase...</option>
                                    <option value="1">Buenos d√≠as</option>
                                    <option value="2">¬øDe d√≥nde eres?</option>
                                    <option value="3">Gracias</option>
                                </select>
                                <div class="alert alert-success text-center fw-bold text-dark" id="traduccionBoxTseltal">...</div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="card p-3 shadow-sm border-0 h-100 tool-card">
                                <h6 class="fw-bold text-warning text-dark mb-3"><i class="fas fa-leaf me-2"></i>Vadem√©cum Herbolario</h6>
                                
                                <div class="accordion accordion-flush" id="fitoAccordion">
                                    
                                    <div class="accordion-item">
                                        <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#fitoDigestivo"><i class="fas fa-utensils me-2"></i>Digestivo</button></h2>
                                        <div id="fitoDigestivo" class="accordion-collapse collapse" data-bs-parent="#fitoAccordion">
                                            <div class="accordion-body">
                                                <div class="plant-item">
                                                    <strong>Guayaba (Hojas):</strong> Diarrea acuosa.<br>
                                                    <span class="small text-muted">üçµ Decocci√≥n: 5-7 hojas en 1L agua. Tomar 3 veces al d√≠a.</span>
                                                </div>
                                                <div class="plant-item">
                                                    <strong>Manzanilla:</strong> C√≥lico / Espasmo.<br>
                                                    <span class="small text-muted">üçµ Infusi√≥n: 1 cda flores por taza. Tapar 5 min.</span>
                                                </div>
                                                <div class="plant-item">
                                                    <strong>Jengibre:</strong> N√°useas / V√≥mito.<br>
                                                    <span class="small text-muted">üçµ Infusi√≥n: 1 rodaja (2cm) o 1g polvo por taza.</span>
                                                </div>
                                                <div class="plant-item">
                                                    <strong>Hierbabuena:</strong> Dispepsia / Gases.<br>
                                                    <span class="small text-muted">üçµ Infusi√≥n: 1 rama fresca por taza despu√©s de comer.</span>
                                                </div>
                                                <div class="plant-item">
                                                    <strong>Estafiate:</strong> Dolor intenso / Par√°sitos.<br>
                                                    <span class="small text-muted">‚ö†Ô∏è Fuerte: Solo 1 ramita peque√±a en 250ml. No exceder.</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="accordion-item">
                                        <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#fitoResp"><i class="fas fa-lungs me-2"></i>Respiratorio</button></h2>
                                        <div id="fitoResp" class="accordion-collapse collapse" data-bs-parent="#fitoAccordion">
                                            <div class="accordion-body">
                                                <div class="plant-item">
                                                    <strong>Bugambilia (Morada):</strong> Tos seca.<br>
                                                    <span class="small text-muted">üçµ Infusi√≥n: 5-10 flores lavadas por taza. Endulzar con miel.</span>
                                                </div>
                                                <div class="plant-item">
                                                    <strong>Gordolobo:</strong> Tos con flemas / Expectorante.<br>
                                                    <span class="small text-muted">üçµ Infusi√≥n: 1 pellizco de flores por taza. Colar bien (pelusa).</span>
                                                </div>
                                                <div class="plant-item">
                                                    <strong>Eucalipto:</strong> Congesti√≥n nasal.<br>
                                                    <span class="small text-muted">‚ô®Ô∏è Vaporizaciones: 3-5 hojas en agua hirviendo. Inhalar vapor.</span>
                                                </div>
                                                <div class="plant-item">
                                                    <strong>Sauco:</strong> Fiebre / Gripe.<br>
                                                    <span class="small text-muted">üçµ Infusi√≥n: 1 cda de flores por taza (Sudor√≠fico).</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="accordion-item">
                                        <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#fitoPiel"><i class="fas fa-hand-holding-medical me-2"></i>Piel y Trauma</button></h2>
                                        <div id="fitoPiel" class="accordion-collapse collapse" data-bs-parent="#fitoAccordion">
                                            <div class="accordion-body">
                                                <div class="plant-item">
                                                    <strong>Tepezcohuite:</strong> Quemaduras / Heridas.<br>
                                                    <span class="small text-muted">üß¥ Polvo directo lavado o pomada al 10%. Regenerador.</span>
                                                </div>
                                                <div class="plant-item">
                                                    <strong>√Årnica (Heterotheca):</strong> Golpes.<br>
                                                    <span class="small text-muted">ü©π Compresas (T√© externo) o Pomada. ‚ö†Ô∏è NO tomar (Hepatot√≥xico).</span>
                                                </div>
                                                <div class="plant-item">
                                                    <strong>S√°bila (Aloe):</strong> Quemadura solar.<br>
                                                    <span class="small text-muted">üß¥ Gel fresco directo (lavar el yodo amarillo primero).</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="accordion-item">
                                        <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#fitoSNC"><i class="fas fa-brain me-2"></i>SNC y Cultural</button></h2>
                                        <div id="fitoSNC" class="accordion-collapse collapse" data-bs-parent="#fitoAccordion">
                                            <div class="accordion-body">
                                                <div class="plant-item">
                                                    <strong>Valeriana:</strong> Insomnio / Ansiedad.<br>
                                                    <span class="small text-muted">üçµ Decocci√≥n ra√≠z (3g) o Tintura (20 gotas noche).</span>
                                                </div>
                                                <div class="plant-item">
                                                    <strong>Pasiflora:</strong> Sedante suave.<br>
                                                    <span class="small text-muted">üçµ Infusi√≥n hojas/tallo: 1 cda por taza.</span>
                                                </div>
                                                <div class="plant-item">
                                                    <strong>Toronjil:</strong> "Susto" / Nervios.<br>
                                                    <span class="small text-muted">üçµ Infusi√≥n (T√© arom√°tico): 1 rama por taza.</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="accordion-item">
                                        <h2 class="accordion-header"><button class="accordion-button collapsed bg-danger text-white" type="button" data-bs-toggle="collapse" data-bs-target="#fitoAlert"><i class="fas fa-exclamation-triangle me-2"></i>Precauci√≥n</button></h2>
                                        <div id="fitoAlert" class="accordion-collapse collapse" data-bs-parent="#fitoAccordion">
                                            <div class="accordion-body">
                                                <div class="plant-item text-danger fw-bold">Ruda (Ruta graveolens):</div>
                                                <div class="small text-muted">Uso cultural ("Aire" o "Limpias"), pero es <span class="text-danger fw-bold">ABORTIVA (Oxit√≥cica)</span>. <br>‚ö†Ô∏è PROHIBIDA su ingesta en embarazo o sospecha. T√≥xica en dosis altas.</div>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="tab-buzon">
                    <div class="row justify-content-center">
                        <div class="col-md-8">
                            <div class="card buzon-card shadow-sm p-4">
                                <div class="text-center mb-4">
                                    <i class="fas fa-envelope-open-text fa-3x text-primary mb-2"></i>
                                    <h4 class="fw-bold">Buz√≥n del Estudiante</h4>
                                    <p class="text-muted small">Tu voz es importante. Identidad protegida.</p>
                                </div>
                                <form id="formBuzon" onsubmit="event.preventDefault(); enviarSugerencia();">
                                    <div class="mb-3">
                                        <label class="fw-bold">Tipo</label>
                                        <select id="sugTipo" class="form-select" required>
                                            <option value="Sugerencia">üí° Sugerencia</option>
                                            <option value="Queja">‚ö†Ô∏è Queja</option>
                                            <option value="Acad√©mico">üìö Acad√©mico</option>
                                        </select>
                                    </div>
                                    <div class="mb-3"><textarea id="sugMsj" class="form-control" rows="4" placeholder="Mensaje..." required></textarea></div>
                                    <button type="submit" class="btn btn-primary w-100 fw-bold">ENVIAR</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <footer class="text-center mt-5">
            <div class="container">
                <p class="mb-1 fw-bold text-white">Comit√© Estudiantil de la Lic. de M√©dico Cirujano UNICH</p>
                <p class="text-white-50 extra-small mb-2">Plataforma independiente desarrollada por estudiantes.</p>
                <p class="text-warning small fw-bold mb-3" style="font-size: 0.8rem;">Construcci√≥n, Desarrollo y Arquitectura: Luis Daniel Aguilar</p>
                <div class="mt-3">
                    <a href="#" class="text-white-50 small text-decoration-none me-3 hover-link" onclick="alert('Disponible pr√≥ximamente')">Aviso de Privacidad</a>
                    <span class="text-white-50">|</span>
                    <a href="#" class="text-white-50 small text-decoration-none ms-3 hover-link" onclick="alert('Disponible pr√≥ximamente')">Tratamiento de datos personales</a>
                </div>
            </div>
        </footer>
    </div>

    <div class="modal fade" id="modalGlasgow" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h6 class="modal-title">Escala de Glasgow</h6><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <label class="small fw-bold">Apertura Ocular (4)</label>
                    <select id="g_ocular" class="form-select mb-2">
                        <option value="4">4. Espont√°nea</option><option value="3">3. A la orden</option><option value="2">2. Al dolor</option><option value="1">1. Ninguna</option>
                    </select>
                    <label class="small fw-bold">Respuesta Verbal (5)</label>
                    <select id="g_verbal" class="form-select mb-2">
                        <option value="5">5. Orientado</option><option value="4">4. Confuso</option><option value="3">3. Palabras inapropiadas</option><option value="2">2. Sonidos incomprensibles</option><option value="1">1. Ninguna</option>
                    </select>
                    <label class="small fw-bold">Respuesta Motora (6)</label>
                    <select id="g_motor" class="form-select mb-3">
                        <option value="6">6. Obedece √≥rdenes</option><option value="5">5. Localiza el dolor</option><option value="4">4. Retira al dolor</option><option value="3">3. Flexi√≥n anormal (Decorticaci√≥n)</option><option value="2">2. Extensi√≥n anormal (Descerebraci√≥n)</option><option value="1">1. Ninguna</option>
                    </select>
                    <button class="btn btn-primary w-100" onclick="calcGlasgow()">Calcular</button>
                    <div id="resGlasgow" class="result-box d-none"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalSilverman" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success"><h6 class="modal-title">Silverman-Anderson (Dificultad Resp.)</h6><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <small class="text-muted d-block mb-2">0 es Normal, 10 es Severo.</small>
                    <div class="mb-2"><label class="small fw-bold">Movimientos Toraco-Abdominales</label><select id="s_mov" class="form-select"><option value="0">0. R√≠tmicos / Regulares</option><option value="1">1. T√≥rax inm√≥vil / Abdomen mueve</option><option value="2">2. Disociaci√≥n (Sube y baja)</option></select></div>
                    <div class="mb-2"><label class="small fw-bold">Tiraje Intercostal</label><select id="s_tir" class="form-select"><option value="0">0. Ausente</option><option value="1">1. Leve / Apenas visible</option><option value="2">2. Marcado / Intenso</option></select></div>
                    <div class="mb-2"><label class="small fw-bold">Retracci√≥n Xifoidea</label><select id="s_ret" class="form-select"><option value="0">0. Ausente</option><option value="1">1. Leve</option><option value="2">2. Marcada</option></select></div>
                    <div class="mb-2"><label class="small fw-bold">Aleteo Nasal</label><select id="s_ale" class="form-select"><option value="0">0. Ausente</option><option value="1">1. M√≠nimo</option><option value="2">2. Marcado</option></select></div>
                    <div class="mb-3"><label class="small fw-bold">Quejido Espiratorio</label><select id="s_que" class="form-select"><option value="0">0. Ausente</option><option value="1">1. Audible con esteto</option><option value="2">2. Audible a distancia</option></select></div>
                    <button class="btn btn-success w-100" onclick="calcSilverman()">Calcular</button>
                    <div id="resSilverman" class="result-box d-none" style="border-color: var(--bs-success); background: #e8fdf5;"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalAlvarado" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger"><h6 class="modal-title">Escala de Alvarado (Apendicitis)</h6><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div class="form-check mb-2"><input class="form-check-input alv-chk" type="checkbox" value="1" id="a1"><label class="form-check-label" for="a1">Migraci√≥n del dolor (1)</label></div>
                    <div class="form-check mb-2"><input class="form-check-input alv-chk" type="checkbox" value="1" id="a2"><label class="form-check-label" for="a2">Anorexia (1)</label></div>
                    <div class="form-check mb-2"><input class="form-check-input alv-chk" type="checkbox" value="1" id="a3"><label class="form-check-label" for="a3">N√°usea / V√≥mitos (1)</label></div>
                    <div class="form-check mb-2"><input class="form-check-input alv-chk" type="checkbox" value="2" id="a4"><label class="form-check-label fw-bold" for="a4">Dolor en C.I.D. (2)</label></div>
                    <div class="form-check mb-2"><input class="form-check-input alv-chk" type="checkbox" value="1" id="a5"><label class="form-check-label" for="a5">Rebote Positivo (Blumberg) (1)</label></div>
                    <div class="form-check mb-2"><input class="form-check-input alv-chk" type="checkbox" value="1" id="a6"><label class="form-check-label" for="a6">Fiebre > 37.3¬∞C (1)</label></div>
                    <div class="form-check mb-2"><input class="form-check-input alv-chk" type="checkbox" value="2" id="a7"><label class="form-check-label fw-bold" for="a7">Leucocitosis (2)</label></div>
                    <div class="form-check mb-3"><input class="form-check-input alv-chk" type="checkbox" value="1" id="a8"><label class="form-check-label" for="a8">Desviaci√≥n a la izquierda (Neutrofilia) (1)</label></div>
                    <button class="btn btn-danger w-100" onclick="calcAlvarado()">Calcular Probabilidad</button>
                    <div id="resAlvarado" class="result-box d-none" style="border-color: var(--bs-danger); background: #fde8e8;"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalObstetrica" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark"><h6 class="modal-title">Calculadora Obst√©trica</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <label class="fw-bold mb-2">Fecha √öltima Menstruaci√≥n (FUM):</label>
                    <input type="date" id="fumInput" class="form-control mb-3">
                    <button class="btn btn-warning w-100 fw-bold" onclick="calcObstetrica()">Calcular FPP y Semanas</button>
                    <div id="resObstetrica" class="result-box d-none" style="border-color: var(--bs-warning); background: #fffbe6; color: #333;"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="iaModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-dark text-white"><h5 class="modal-title">Dr. Evidence</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body bg-light">
                    <div id="chatHistory" class="p-3 mb-3 bg-white rounded shadow-sm" style="height: 350px; overflow-y: auto;"></div>
                    <div class="input-group">
                        <input type="text" id="iaQuery" class="form-control" placeholder="Consulta m√©dica..." onkeypress="if(event.key === 'Enter') consultarIA()">
                        <button class="btn btn-dark" onclick="consultarIA()"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, getDocs, query, where, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBxl7NFNI8lxfmdC-YJYmZ21zQOxQ72-3U", authDomain: "centro-de-recursos-academicos.firebaseapp.com", projectId: "centro-de-recursos-academicos", storageBucket: "centro-de-recursos-academicos.firebasestorage.app", messagingSenderId: "799558207054", appId: "1:799558207054:web:c7bb8f1400a4f2181ee51f", measurementId: "G-GWC94WNY9F" };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUserData = null;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('login-view').style.display = 'none';
                document.getElementById('app-view').style.display = 'block';
                await cargarPerfil(user.uid);
                cargarFavoritosNube(user.uid);
                if(window.cargarReto) window.cargarReto(); 
            } else {
                document.getElementById('login-view').style.display = 'flex';
                document.getElementById('app-view').style.display = 'none';
            }
        });

        window.login = async () => { try { await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value); } catch (e) { document.getElementById('loginError').textContent="Error: Credenciales incorrectas."; document.getElementById('loginError').classList.remove('d-none'); } };
        window.registrar = async () => { try { const cred = await createUserWithEmailAndPassword(auth, document.getElementById('regEmail').value, document.getElementById('regPass').value); await setDoc(doc(db, "estudiantes", cred.user.uid), { nombre: document.getElementById('regName').value, semestre: document.getElementById('regSemestre').value, email: document.getElementById('regEmail').value }); } catch (e) { alert("Error: " + e.message); } };
        window.logout = () => signOut(auth);
        window.toggleRegister = () => { const l=document.getElementById('formLogin'), r=document.getElementById('formRegister'); l.style.display=l.style.display==='none'?'block':'none'; r.style.display=r.style.display==='none'?'block':'none'; };

        async function cargarPerfil(uid) {
            const snap = await getDoc(doc(db, "estudiantes", uid));
            if (snap.exists()) {
                currentUserData = snap.data();
                const nombrePila = currentUserData.nombre.split(' ')[0].toLowerCase();
                const excepcionesFemeninas = ['beatriz', 'noemi', 'jazmin', 'abril', 'raquel', 'guadalupe', 'lizbeth', 'monserrat', 'carmen', 'dolores', 'luz', 'pilar', 'rosario', 'consuelo', 'mercedes', 'belen', 'esther', 'judith', 'ruth', 'xochitl', 'citlalli', 'yazmin', 'karen', 'sharon', 'jocelyn', 'allison'];
                let prefijo = "Dr.";
                if (nombrePila.endsWith('a') || excepcionesFemeninas.includes(nombrePila)) { prefijo = "Dra."; }
                document.getElementById('userNameDisplay').textContent = prefijo + " " + currentUserData.nombre;
                document.getElementById('userSemestreDisplay').textContent = currentUserData.semestre + (isNaN(currentUserData.semestre)?'':'¬∞ Semestre');
            }
        }

        window.enviarSugerencia = async () => {
            if(!auth.currentUser) return;
            const tipo = document.getElementById('sugTipo').value;
            const msj = document.getElementById('sugMsj').value;
            // SE ELIMIN√ì LA L√ìGICA DE AN√ìNIMO
            if(!msj.trim()) { alert("Escribe un mensaje."); return; }
            try {
                await addDoc(collection(db, "buzon"), {
                    tipo: tipo, mensaje: msj, fecha: new Date(),
                    usuario: currentUserData.nombre, // SIEMPRE ENV√çA NOMBRE
                    semestre: currentUserData.semestre, // SIEMPRE ENV√çA SEMESTRE
                    uid: auth.currentUser.uid
                });
                alert("¬°Enviado! Gracias."); document.getElementById('formBuzon').reset();
            } catch(e) { alert("Error: " + e.message); }
        };

        window.cargarFavoritosNube = async (uid) => {
            const container = document.getElementById('favoritos-container');
            container.innerHTML = '<div class="col-12 text-center py-5"><div class="spinner-border text-primary" role="status"></div></div>';
            try {
                const q = query(collection(db, "favoritos"), where("uid", "==", uid));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) { container.innerHTML = '<div class="col-12 text-center text-muted small py-3"><i class="fas fa-star text-secondary opacity-25 fa-2x mb-2"></i><br>No tienes favoritos guardados en la nube.</div>'; return; }
                let html = '';
                querySnapshot.forEach((docSnap) => { const data = docSnap.data(); html += `<div class="col-md-6 animate__animated animate__fadeIn"><div class="fav-book-item d-flex justify-content-between align-items-center"><div class="text-truncate"><i class="fas fa-book text-primary me-2"></i><a href="${data.url}" target="_blank" class="text-decoration-none text-dark fw-bold small">${data.title}</a></div><button onclick="eliminarFavoritoNube('${docSnap.id}')" class="btn btn-sm text-danger" title="Eliminar"><i class="fas fa-trash-alt"></i></button></div></div>`; });
                container.innerHTML = html;
            } catch (e) { container.innerHTML = '<div class="text-danger text-center">Error al cargar.</div>'; }
        }
        window.eliminarFavoritoNube = async (docId) => { if(confirm("¬øQuitar de favoritos?")) { try { await deleteDoc(doc(db, "favoritos", docId)); if(auth.currentUser) cargarFavoritosNube(auth.currentUser.uid); } catch(e) { alert("Error."); } } }
    </script>

    <script>
        // --- FUNCIONES INTERCULTURALIDAD ---
        window.traducir = function() {
            const op = document.getElementById('fraseSelect').value;
            const txt = op=='1'?"Lek oyoxuk":op=='2'?"¬øBu x-a'i k'ux?":"...";
            document.getElementById('traduccionBox').textContent = txt;
        };

        window.traducirTseltal = function() {
            const op = document.getElementById('fraseSelectTseltal').value;
            let txt = "...";
            if(op == '1') txt = "Bame ayat";
            if(op == '2') txt = "Banti talemat";
            if(op == '3') txt = "Wokolawal";
            document.getElementById('traduccionBoxTseltal').textContent = txt;
        };

        // --- FUNCIONES PARA MODALES INTERACTIVOS ---
        
        window.calcGlasgow = function() {
            const o = parseInt(document.getElementById('g_ocular').value);
            const v = parseInt(document.getElementById('g_verbal').value);
            const m = parseInt(document.getElementById('g_motor').value);
            const total = o + v + m;
            let desc = "";
            if(total >= 13) desc = "Traumatismo Leve";
            else if(total >= 9) desc = "Traumatismo Moderado";
            else desc = "Traumatismo Severo (Intubaci√≥n)";
            
            const box = document.getElementById('resGlasgow');
            box.innerHTML = `${total} Puntos<br><span class="small fw-normal">${desc}</span>`;
            box.classList.remove('d-none');
        };

        window.calcSilverman = function() {
            const total = 
                parseInt(document.getElementById('s_mov').value) +
                parseInt(document.getElementById('s_tir').value) +
                parseInt(document.getElementById('s_ret').value) +
                parseInt(document.getElementById('s_ale').value) +
                parseInt(document.getElementById('s_que').value);
            
            let desc = "";
            if(total === 0) desc = "Sin dificultad respiratoria";
            else if(total <= 3) desc = "Dificultad Leve";
            else if(total <= 6) desc = "Dificultad Moderada";
            else desc = "Dificultad Severa";

            const box = document.getElementById('resSilverman');
            box.innerHTML = `${total} Puntos<br><span class="small fw-normal">${desc}</span>`;
            box.classList.remove('d-none');
        };

        window.calcAlvarado = function() {
            let total = 0;
            document.querySelectorAll('.alv-chk:checked').forEach(c => total += parseInt(c.value));
            
            let desc = "";
            if(total <= 4) desc = "Baja probabilidad";
            else if(total <= 6) desc = "Posible (Observaci√≥n)";
            else desc = "Alta probabilidad (Cirug√≠a)";

            const box = document.getElementById('resAlvarado');
            box.innerHTML = `${total}/10 Puntos<br><span class="small fw-normal">${desc}</span>`;
            box.classList.remove('d-none');
        };

        window.calcObstetrica = function() {
            const fumStr = document.getElementById('fumInput').value;
            if(!fumStr) return;
            
            const fum = new Date(fumStr);
            const hoy = new Date();
            
            // FPP (Naegele: +7 d√≠as, -3 meses, +1 a√±o aprox o +280 dias)
            // Metodo simple: FUM + 280 dias
            const fpp = new Date(fum);
            fpp.setDate(fum.getDate() + 280);
            
            // Semanas (Diferencia en milisegundos)
            const diffTime = Math.abs(hoy - fum);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            const semanas = Math.floor(diffDays / 7);
            const dias = diffDays % 7;

            const box = document.getElementById('resObstetrica');
            box.innerHTML = `<strong>SDG:</strong> ${semanas}.${dias} semanas<br><strong>FPP:</strong> ${fpp.toLocaleDateString('es-ES')}`;
            box.classList.remove('d-none');
        };


        // --- BANCO DE PREGUNTAS (30 High Yield) ---
        const bancoPreguntas = [
            { p: "¬øTratamiento de primera l√≠nea para la Enfermedad de Kawasaki?", a: ["Aspirina + IGIV", "Corticoides", "Antibi√≥ticos"], c: 0, why: "‚úÖ Correcto. Previene aneurismas coronarios." },
            { p: "¬øTriada cl√°sica del embarazo ect√≥pico?", a: ["Dolor, Sangrado, Masa anexial", "Fiebre, Dolor, Leucorrea", "Sangrado, Hipertensi√≥n, Edema"], c: 0, why: "‚úÖ Correcto. Dolor abdominal, amenorrea/sangrado y masa." },
            { p: "¬øEscala para diagn√≥stico de Apendicitis?", a: ["Alvarado", "Ranson", "Glasgow"], c: 0, why: "‚úÖ Correcto. MANTRELS (Alvarado)." },
            { p: "¬øCriterio diagn√≥stico de Diabetes Mellitus (HbA1c)?", a: ["> 6.0%", "‚â• 6.5%", "> 7.0%"], c: 1, why: "‚úÖ Correcto. HbA1c mayor o igual a 6.5%." },
            { p: "¬øQu√© eval√∫a la escala de Silverman-Anderson?", a: ["Dificultad respiratoria neonatal", "Vitalidad al nacer", "Edad gestacional"], c: 0, why: "‚úÖ Correcto. A menor puntaje, mejor condici√≥n." },
            { p: "¬øSigno caracter√≠stico de la Colecistitis Aguda?", a: ["Murphy (+)", "McBurney (+)", "Rovsing (+)"], c: 0, why: "‚úÖ Correcto. Cese de la inspiraci√≥n a la palpaci√≥n." },
            { p: "¬øAgente causal m√°s frecuente de Mastitis Puerperal?", a: ["S. aureus", "E. coli", "Streptococcus B"], c: 0, why: "‚úÖ Correcto. Staphylococcus aureus." },
            { p: "¬øTratamiento erradicador de H. pylori?", a: ["Omeprazol + Claritro + Amoxi", "Metro + Cipro", "Solo Omeprazol"], c: 0, why: "‚úÖ Correcto. Triple terapia est√°ndar." },
            { p: "¬øHernia inguinal que pasa por el anillo inguinal profundo?", a: ["Indirecta", "Directa", "Crural"], c: 0, why: "‚úÖ Correcto. La indirecta es cong√©nita (lateral)." },
            { p: "¬øSigno de Koplik es patognom√≥nico de...?", a: ["Sarampi√≥n", "Rubeola", "Varicela"], c: 0, why: "‚úÖ Correcto. Manchas blancas en mucosa oral." },
            { p: "¬øCausa m√°s frecuente de sangrado posparto?", a: ["Aton√≠a uterina", "Laceraciones", "Retenci√≥n restos"], c: 0, why: "‚úÖ Correcto. Las 4 T (Tono es la 1ra)." },
            { p: "¬øClasificaci√≥n para Neumon√≠a Adquirida en Comunidad?", a: ["CURB-65", "GOLD", "NYHA"], c: 0, why: "‚úÖ Correcto. Define ingreso hospitalario." },
            { p: "¬øHeces en 'jalea de grosella' sugiere...?", a: ["Invaginaci√≥n intestinal", "Estenosis pil√≥rica", "Apendicitis"], c: 0, why: "‚úÖ Correcto. Urgencia pedi√°trica." },
            { p: "¬øSangrado transvaginal indoloro en 3er trimestre?", a: ["Placenta Previa", "Desprendimiento", "Ruptura uterina"], c: 0, why: "‚úÖ Correcto. No realizar tacto vaginal." },
            { p: "¬øTratamiento de elecci√≥n para S√≠filis?", a: ["Penicilina G Benzat√≠nica", "Ceftriaxona", "Azitromicina"], c: 0, why: "‚úÖ Correcto. 2.4 Millones UI IM." },
            { p: "¬øDosis t√≥xica de Paracetamol en adultos?", a: ["> 4g", "> 7.5 - 10g", "> 2g"], c: 1, why: "‚úÖ Correcto. Riesgo de fallo hep√°tico fulminante." },
            { p: "¬øAnt√≠doto para intoxicaci√≥n por Opioides?", a: ["Naloxona", "Flumazenil", "N-acetilciste√≠na"], c: 0, why: "‚úÖ Correcto. Revierte depresi√≥n respiratoria." },
            { p: "¬øGold Standard para diagn√≥stico de tuberculosis?", a: ["Cultivo", "Baciloscop√≠a", "PPD"], c: 0, why: "‚úÖ Correcto. El cultivo confirma." },
            { p: "¬øVector del Dengue, Zika y Chikungunya?", a: ["Aedes aegypti", "Anopheles", "Lutzomyia"], c: 0, why: "‚úÖ Correcto. El mosquito Aedes." },
            { p: "¬øTriada de Charcot (Colangitis)?", a: ["Fiebre, Ictericia, Dolor", "Fiebre, Tos, Disnea", "Dolor, Sangrado, Masa"], c: 0, why: "‚úÖ Correcto. Si hay shock = Pentada de Reynolds." },
            { p: "¬øPrincipal causa de hipotiroidismo (zonas con yodo)?", a: ["Hashimoto", "Graves", "Tiroiditis viral"], c: 0, why: "‚úÖ Correcto. Tiroiditis autoinmune." },
            { p: "¬øMedicamento de elecci√≥n para crisis de ausencia?", a: ["Valproato / Etosuximida", "Carbamazepina", "Fenito√≠na"], c: 0, why: "‚úÖ Correcto." },
            { p: "¬øSigno de la 'tecla' se ve en...?", a: ["Luxaci√≥n Acromioclavicular", "Fractura de Colles", "Luxaci√≥n de hombro"], c: 0, why: "‚úÖ Correcto." },
            { p: "¬øF√°rmaco de rescate en crisis asm√°tica?", a: ["SABA (Salbutamol)", "ICS (Budesonida)", "LABA"], c: 0, why: "‚úÖ Correcto. Broncodilatador de acci√≥n corta." },
            { p: "¬øManiobra para desobstrucci√≥n de v√≠a a√©rea?", a: ["Heimlich", "Valsalva", "Leopold"], c: 0, why: "‚úÖ Correcto." },
            { p: "¬øF√≥rmula para reposici√≥n h√≠drica en quemados?", a: ["Parkland", "Hollyday", "Brooke"], c: 0, why: "‚úÖ Correcto. 4ml x kg x %SCQ." },
            { p: "¬øAntibi√≥tico que causa 'S√≠ndrome del ni√±o gris'?", a: ["Cloranfenicol", "Amoxicilina", "Ceftriaxona"], c: 0, why: "‚úÖ Correcto." },
            { p: "¬øTratamiento de elecci√≥n para Giardia lamblia?", a: ["Metronidazol", "Albendazol", "Pamoato"], c: 0, why: "‚úÖ Correcto." },
            { p: "¬øFractura m√°s com√∫n en ni√±os?", a: ["Tallo verde", "Espiral", "Conminuta"], c: 0, why: "‚úÖ Correcto. Periostio grueso evita ruptura total." },
            { p: "¬øDeficiencia vitam√≠nica que causa Pelagra?", a: ["B3 (Niacina)", "B1 (Tiamina)", "C (Asc√≥rbico)"], c: 0, why: "‚úÖ Correcto. Demencia, Dermatitis, Diarrea." }
        ];

        window.cargarReto = function() {
            const container = document.getElementById('quizContainer');
            const randomIdx = Math.floor(Math.random() * bancoPreguntas.length);
            const q = bancoPreguntas[randomIdx];
            
            // LOGICA DE BARAJADO (SHUFFLE)
            let opciones = q.a.map((texto, indice) => {
                return { texto: texto, esCorrecta: indice === q.c };
            });
            opciones.sort(() => Math.random() - 0.5);

            let html = `<p class="small mb-3 fw-bold">${q.p}</p>`;
            opciones.forEach((opcion) => {
                const accion = opcion.esCorrecta 
                    ? `this.style.background='#d4edda'; this.style.borderColor='#c3e6cb'; this.innerHTML='${q.why}';` 
                    : `this.style.background='#f8d7da'; this.style.borderColor='#f5c6cb'; this.innerText='‚ùå Incorrecto';`;
                html += `<div class="quiz-option text-white" onclick="${accion}">${opcion.texto}</div>`;
            });
            container.innerHTML = html;
        };

        // --- CALCULADORA ---
        window.calcularTodo = function() {
            try {
                const inputPeso = document.getElementById('pesoCalc');
                const selectTipo = document.getElementById('tipoPaciente');
                if (!inputPeso || !selectTipo) return;
                
                const peso = parseFloat(inputPeso.value);
                const tipo = selectTipo.value; 
                
                if (!peso || peso <= 0) { alert("Por favor ingresa un peso v√°lido."); return; }

                document.getElementById('listaPediatria').style.display = 'none';
                document.getElementById('listaAdultos').style.display = 'none';

                if (tipo === 'ped') {
                    // PEDIATR√çA
                    let para = peso * 15; document.getElementById('pedPara').textContent = (para > 500 ? "500 mg (TOPE)" : para.toFixed(0) + " mg");
                    let ibu = peso * 10; document.getElementById('pedIbu').textContent = (ibu > 400 ? "400 mg (TOPE)" : ibu.toFixed(0) + " mg");
                    let meta = peso * 10; document.getElementById('pedMeta').textContent = (meta > 1000 ? "1 g (TOPE)" : meta.toFixed(0) + " mg");
                    let amoxDosis = (peso * 50) / 3; document.getElementById('pedAmox').textContent = (amoxDosis > 1000 ? "1 g (TOPE)" : amoxDosis.toFixed(0) + " mg");
                    let cefDosis = (peso * 50) / 2; document.getElementById('pedCeft').textContent = (cefDosis > 1000 ? "1 g (TOPE)" : cefDosis.toFixed(0) + " mg");
                    let tmpDosis = (peso * 8) / 2; document.getElementById('pedTmp').textContent = (tmpDosis > 160 ? "160 mg TMP (TOPE)" : tmpDosis.toFixed(0) + " mg TMP");
                    let azit = peso * 10; document.getElementById('pedAzit').textContent = (azit > 500 ? "500 mg (TOPE)" : azit.toFixed(0) + " mg");
                    let cefaDosis = (peso * 50) / 4; document.getElementById('pedCefa').textContent = (cefaDosis > 1000 ? "1 g (TOPE)" : cefaDosis.toFixed(0) + " mg");
                    document.getElementById('pedSalb').textContent = (peso * 0.1).toFixed(2) + " mg";
                    document.getElementById('pedAmbr').textContent = ((peso * 1.5)/3).toFixed(1) + " mg";
                    document.getElementById('pedLora').textContent = (peso < 30) ? "5 mg" : "10 mg";
                    document.getElementById('pedCeti').textContent = (peso * 0.25).toFixed(1) + " mg";
                    let pred = peso * 1; document.getElementById('pedPred').textContent = (pred > 60 ? "60 mg (TOPE)" : pred.toFixed(0) + " mg");
                    let dexa = peso * 0.6; if(dexa > 16) dexa = 16; document.getElementById('pedDexa').textContent = dexa.toFixed(1) + " mg";
                    let adre = peso * 0.01; if(adre > 0.3) adre = 0.3; document.getElementById('pedAdre').textContent = adre.toFixed(2) + " mg";
                    let hidro = peso * 5; document.getElementById('pedHidro').textContent = (hidro > 200 ? "200 mg (TOPE)" : hidro.toFixed(0) + " mg");
                    let diaz = peso * 0.3; document.getElementById('pedDiaz').textContent = (diaz > 10 ? "10 mg (TOPE)" : diaz.toFixed(1) + " mg");
                    let mida = peso * 0.15; document.getElementById('pedMida').textContent = (mida > 5 ? "5 mg (TOPE)" : mida.toFixed(1) + " mg");
                    let onda = peso * 0.15; if(onda > 8) onda = 8; document.getElementById('pedOnda').textContent = onda.toFixed(1) + " mg";
                    let meto = peso * 0.15; document.getElementById('pedMeto').textContent = (meto > 10 ? "10 mg (TOPE)" : meto.toFixed(1) + " mg");
                    document.getElementById('listaPediatria').style.display = 'block';
                } else {
                    // ADULTOS
                    document.getElementById('aduLiq').textContent = (peso * 35).toFixed(0) + " ml/d√≠a";
                    document.getElementById('aduIns').textContent = (peso * 0.5).toFixed(0) + " UI";
                    let tram = peso * 1; document.getElementById('aduTram').textContent = (tram > 100 ? "100 mg (TOPE)" : tram.toFixed(0) + " mg");
                    let enox = peso * 1; document.getElementById('aduEnox').textContent = (enox > 100 ? "100 mg (TOPE)" : enox.toFixed(0) + " mg");
                    document.getElementById('listaAdultos').style.display = 'block';
                }
                const res = document.getElementById('resultadosDosis');
                res.style.display = 'block';
                res.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } catch (e) { alert("Error: " + e.message); }
        };

        window.traducir = function() {
            const op = document.getElementById('fraseSelect').value;
            const txt = op=='1'?"Lek oyoxuk":op=='2'?"¬øBu x-a'i k'ux?":"...";
            document.getElementById('traduccionBox').textContent = txt;
        };

        const GROQ_API_KEY = "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"; 
        window.abrirIA = function() { new bootstrap.Modal(document.getElementById('iaModal')).show(); };
        window.consultarIA = async function() {
            const i = document.getElementById('iaQuery'), c = document.getElementById('chatHistory'), p = i.value.trim();
            if(!p) return;
            c.innerHTML += `<div class="chat-msg-user"><span>${p}</span></div>`; i.value = ''; c.scrollTop = c.scrollHeight;
            const lid = "l"+Date.now(); c.innerHTML += `<div id="${lid}" class="text-muted small"><i class="fas fa-spinner fa-spin"></i> ...</div>`;
            try {
                const r = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST", headers: { "Content-Type": "application/json", "Authorization": `Bearer ${GROQ_API_KEY}` },
                    body: JSON.stringify({ model: "llama-3.3-70b-versatile", messages: [{role:"system",content:"Eres Dr. Evidence."}, {role:"user",content:p}] })
                });
                const d = await r.json(); document.getElementById(lid).remove();
                if(d.choices) {
                    const t = d.choices[0].message.content.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\n/g,'<br>');
                    c.innerHTML += `<div class="chat-msg-ai"><div>${t}</div></div>`;
                }
            } catch(e) { document.getElementById(lid).innerHTML = "Error."; }
            c.scrollTop = c.scrollHeight;
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
