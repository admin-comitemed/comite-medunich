<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aula Virtual | Comité Medicina</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <style>
        :root { --primary: #003366; --accent: #d4af37; --bg: #f4f6f9; }
        body { background-color: var(--bg); font-family: 'Segoe UI', sans-serif; }
        
        /* LOGIN VIEW */
        #login-view { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, var(--primary) 0%, #001f3f 100%); padding: 20px; }
        .login-card { background: white; padding: 2.5rem; border-radius: 15px; width: 100%; max-width: 450px; box-shadow: 0 15px 35px rgba(0,0,0,0.3); }
        
        /* APP VIEW */
        #app-view { display: none; }
        .navbar-custom { background-color: var(--primary); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .student-card { background: linear-gradient(to right, #003366, #004080); color: white; border-radius: 15px; padding: 25px; position: relative; overflow: hidden; }
        
        /* BOTÓN FLOTANTE SUBIR */
        .upload-btn { position: fixed; bottom: 30px; right: 30px; border-radius: 50%; width: 60px; height: 60px; font-size: 24px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 1000; transition: transform 0.3s; }
        .upload-btn:hover { transform: scale(1.1); }

        /* CHAT IA */
        .chat-msg-user { text-align: right; margin-bottom: 10px; }
        .chat-msg-user span { background-color: var(--primary); color: white; padding: 8px 12px; border-radius: 15px 15px 0 15px; display: inline-block; }
        .chat-msg-ai { text-align: left; margin-bottom: 10px; }
        .chat-msg-ai div { background-color: #e9ecef; padding: 10px 15px; border-radius: 15px 15px 15px 0; display: inline-block; }
    </style>
</head>
<body>

    <div id="login-view">
        <div class="login-card animate__animated animate__fadeInUp">
            <div class="text-center mb-4">
                <i class="fas fa-user-md fa-4x text-primary mb-3"></i>
                <h3 class="fw-bold text-dark">Acceso Alumnos</h3>
                <p class="text-muted small">Plataforma Oficial del Comité</p>
            </div>

            <form id="formLogin" onsubmit="event.preventDefault(); login();">
                <div class="form-floating mb-3">
                    <input type="email" id="email" class="form-control" placeholder="nombre@ejemplo.com" required>
                    <label>Correo Institucional o Personal</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="password" id="password" class="form-control" placeholder="Contraseña" required>
                    <label>Contraseña</label>
                </div>
                <button type="submit" class="btn btn-primary w-100 py-2 fw-bold mb-3">INGRESAR AL AULA</button>
                <div class="d-flex justify-content-between align-items-center mt-4">
                    <a href="index.html" class="text-decoration-none small text-muted"><i class="fas fa-arrow-left me-1"></i> Volver al Lobby</a>
                    <a href="#" onclick="toggleRegister()" class="text-decoration-none small fw-bold">Crear cuenta nueva</a>
                </div>
            </form>

            <form id="formRegister" style="display:none;" onsubmit="event.preventDefault(); registrar();">
                <h5 class="fw-bold mb-3 text-center">Registro de Nuevo Ingreso</h5>
                <div class="mb-2"><input type="text" id="regName" class="form-control" placeholder="Nombre Completo (Dr./Dra.)" required></div>
                
                <div class="mb-2">
                    <select id="regSemestre" class="form-select" required>
                        <option value="" disabled selected>Selecciona tu Grado</option>
                        <option value="1">1er Semestre</option>
                        <option value="2">2do Semestre</option>
                        <option value="3">3er Semestre</option>
                        <option value="4">4to Semestre</option>
                        <option value="5">5to Semestre</option>
                        <option value="6">6to Semestre</option>
                        <option value="7">7mo Semestre</option>
                        <option value="8">8vo Semestre</option>
                        <option value="9">9no Semestre</option>
                        <option value="10">10mo Semestre</option>
                        <option value="Internado">Internado Médico de Pregrado</option>
                        <option value="Servicio">Servicio Social</option>
                    </select>
                </div>
                
                <div class="mb-2"><input type="email" id="regEmail" class="form-control" placeholder="Correo electrónico" required></div>
                <div class="mb-3"><input type="password" id="regPass" class="form-control" placeholder="Crear Contraseña (Min 6 car.)" required></div>
                
                <button type="submit" class="btn btn-success w-100 fw-bold">REGISTRARME</button>
                <div class="text-center mt-3"><a href="#" onclick="toggleRegister()" class="small text-muted">Cancelar</a></div>
            </form>
            
            <div id="loginError" class="alert alert-danger mt-3 small d-none text-center"></div>
        </div>
    </div>

    <div id="app-view">
        <nav class="navbar navbar-dark navbar-custom mb-4 sticky-top">
            <div class="container">
                <a class="navbar-brand fw-bold" href="#"><i class="fas fa-laptop-medical me-2"></i>Aula Virtual</a>
                <div class="d-flex align-items-center">
                    <button class="btn btn-sm btn-light text-primary me-2 fw-bold rounded-pill px-3" onclick="abrirIA()">
                        <i class="fas fa-brain me-1"></i>Dr. Evidence
                    </button>
                    <button class="btn btn-sm btn-outline-light" onclick="logout()" title="Cerrar Sesión"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </div>
        </nav>

        <div class="container pb-5">
            <div class="student-card mb-4 shadow animate__animated animate__fadeIn">
                <div class="d-flex align-items-center position-relative" style="z-index: 2;">
                    <div class="bg-white text-primary rounded-circle p-3 me-3 border border-4 border-info"><i class="fas fa-user-graduate fa-2x"></i></div>
                    <div>
                        <h6 class="text-warning text-uppercase mb-0 small fw-bold">Sesión Activa</h6>
                        <h2 class="fw-bold mb-0" id="userNameDisplay">Cargando...</h2>
                        <span class="badge bg-light text-dark mt-2" id="userSemestreDisplay">...</span>
                    </div>
                </div>
            </div>

            <ul class="nav nav-tabs nav-justified mb-4" id="myTab" role="tablist">
                <li class="nav-item"><button class="nav-link active fw-bold" data-bs-toggle="tab" data-bs-target="#biblioteca"><i class="fas fa-book me-2"></i>Biblioteca</button></li>
                <li class="nav-item"><button class="nav-link fw-bold" data-bs-toggle="tab" data-bs-target="#calculadoras"><i class="fas fa-calculator me-2"></i>Calculadoras</button></li>
                <li class="nav-item"><button class="nav-link fw-bold" data-bs-toggle="tab" data-bs-target="#apuntes" onclick="cargarAportes()"><i class="fas fa-users me-2"></i>Comunidad</button></li>
            </ul>

            <div class="tab-content">
                <div class="tab-pane fade show active" id="biblioteca">
                    <div class="alert alert-info border-0 shadow-sm"><i class="fas fa-info-circle me-2"></i>Libros base seleccionados por el Comité.</div>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="card p-3 h-100 shadow-sm border-0">
                                <h6 class="fw-bold">Nelson. Tratado de Pediatría</h6>
                                <p class="small text-muted">21ª Edición. Referencia obligatoria.</p>
                                <button class="btn btn-sm btn-outline-primary mt-auto w-100">Descargar PDF</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="calculadoras">
                    <div class="text-center py-5">
                        <i class="fas fa-tools fa-3x text-muted mb-3"></i>
                        <h5>Herramientas Clínicas</h5>
                        <p class="text-muted">Próximamente: Dosis Pediátricas y Escalas.</p>
                    </div>
                </div>

                <div class="tab-pane fade" id="apuntes">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="fw-bold text-secondary">Material compartido</h5>
                        <button class="btn btn-primary btn-sm rounded-pill" onclick="abrirSubirArchivo()"><i class="fas fa-cloud-upload-alt me-2"></i>Subir Aporte</button>
                    </div>
                    <div id="listaAportes" class="row g-3">
                        <div class="text-center py-5"><div class="spinner-border text-primary" role="status"></div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="uploadModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Compartir Conocimiento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="uploadForm" onsubmit="event.preventDefault(); subirArchivo();">
                        <div class="mb-3">
                            <label class="form-label">Título</label>
                            <input type="text" id="fileTitle" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Archivo</label>
                            <input type="file" id="fileInput" class="form-control" accept=".pdf,.jpg,.png" required>
                        </div>
                        <div id="uploadStatus" class="d-none mb-2">
                            <div class="progress"><div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%"></div></div>
                        </div>
                        <button type="submit" id="btnSubir" class="btn btn-primary w-100">Publicar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="iaModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title">Dr. Evidence</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body bg-light">
                    <div id="chatHistory" class="p-3 mb-3 bg-white rounded shadow-sm" style="height: 350px; overflow-y: auto;"></div>
                    <div class="input-group">
                        <input type="text" id="iaQuery" class="form-control" placeholder="Consulta..." onkeypress="if(event.key === 'Enter') consultarIA()">
                        <button class="btn btn-dark" onclick="consultarIA()"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBxl7NFNI8lxfmdC-YJYmZ21zQOxQ72-3U",
            authDomain: "centro-de-recursos-academicos.firebaseapp.com",
            projectId: "centro-de-recursos-academicos",
            storageBucket: "centro-de-recursos-academicos.firebasestorage.app",
            messagingSenderId: "799558207054",
            appId: "1:799558207054:web:c7bb8f1400a4f2181ee51f",
            measurementId: "G-GWC94WNY9F"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        let currentUserData = null;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('login-view').style.display = 'none';
                document.getElementById('app-view').style.display = 'block';
                await cargarPerfil(user.uid);
                cargarAportes();
            } else {
                document.getElementById('login-view').style.display = 'flex';
                document.getElementById('app-view').style.display = 'none';
            }
        });

        window.toggleRegister = () => {
            const l = document.getElementById('formLogin'), r = document.getElementById('formRegister');
            l.style.display = l.style.display === 'none' ? 'block' : 'none';
            r.style.display = r.style.display === 'none' ? 'block' : 'none';
        };

        window.login = async () => {
            try {
                await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value);
            } catch (e) { showError("Credenciales incorrectas."); }
        };

        // REGISTRO SIN CAPTCHA (Modificado)
        window.registrar = async () => {
            // Se eliminó la verificación de grecaptcha.getResponse() para evitar el error de dominio.
            try {
                const cred = await createUserWithEmailAndPassword(auth, document.getElementById('regEmail').value, document.getElementById('regPass').value);
                await setDoc(doc(db, "estudiantes", cred.user.uid), {
                    nombre: document.getElementById('regName').value,
                    semestre: document.getElementById('regSemestre').value,
                    email: document.getElementById('regEmail').value,
                    rol: "estudiante"
                });
            } catch (e) { showError(e.message); }
        };

        window.logout = () => signOut(auth);

        function showError(msg) {
            const err = document.getElementById('loginError');
            err.textContent = msg;
            err.classList.remove('d-none');
        }

        async function cargarPerfil(uid) {
            const snap = await getDoc(doc(db, "estudiantes", uid));
            if (snap.exists()) {
                currentUserData = snap.data();
                let sem = currentUserData.semestre;
                if(sem !== 'Internado' && sem !== 'Servicio') sem += '° Semestre';
                document.getElementById('userNameDisplay').textContent = "Dr(a). " + currentUserData.nombre;
                document.getElementById('userSemestreDisplay').textContent = sem;
            }
        }

        window.abrirSubirArchivo = () => new bootstrap.Modal(document.getElementById('uploadModal')).show();

        window.subirArchivo = async () => {
            const file = document.getElementById('fileInput').files[0];
            const title = document.getElementById('fileTitle').value;
            if(!file) return;
            document.getElementById('btnSubir').disabled = true;
            document.getElementById('uploadStatus').classList.remove('d-none');
            document.getElementById('progressBar').style.width = "50%";
            try {
                const storageRef = ref(storage, 'aportes/' + Date.now() + '_' + file.name);
                await uploadBytes(storageRef, file);
                document.getElementById('progressBar').style.width = "100%";
                const url = await getDownloadURL(storageRef);
                await addDoc(collection(db, "aportes"), {
                    titulo: title, url: url, autor: currentUserData ? currentUserData.nombre : "Anónimo",
                    semestreAutor: currentUserData ? currentUserData.semestre : "?", fecha: new Date(), tipo: file.type
                });
                alert("¡Aporte publicado!");
                bootstrap.Modal.getInstance(document.getElementById('uploadModal')).hide();
                document.getElementById('uploadForm').reset();
                document.getElementById('uploadStatus').classList.add('d-none');
                document.getElementById('btnSubir').disabled = false;
                cargarAportes();
            } catch (error) { alert("Error: " + error.message); document.getElementById('btnSubir').disabled = false; }
        };

        window.cargarAportes = async () => {
            const lista = document.getElementById('listaAportes');
            try {
                const q = query(collection(db, "aportes"), orderBy("fecha", "desc"), limit(20));
                const snap = await getDocs(q);
                let html = "";
                if (snap.empty) html = '<div class="text-center py-4 text-muted">Aún no hay aportes.</div>';
                else {
                    snap.forEach((doc) => {
                        const d = doc.data();
                        const icono = d.tipo.includes('pdf') ? 'fa-file-pdf text-danger' : 'fa-file-image text-primary';
                        html += `<div class="col-md-6 col-lg-4"><div class="card p-3 h-100 shadow-sm border-0"><div class="d-flex justify-content-between"><span class="badge bg-light text-dark mb-2">${d.semestreAutor}</span></div><h6 class="fw-bold text-truncate"><i class="fas ${icono} me-2"></i>${d.titulo}</h6><p class="small text-muted">Por: ${d.autor}</p><a href="${d.url}" target="_blank" class="btn btn-sm btn-outline-secondary mt-auto w-100">Ver Material</a></div></div>`;
                    });
                }
                lista.innerHTML = html;
            } catch (e) { console.log(e); }
        };
    </script>

    <script>
        const GROQ_API_KEY = "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"; 
        function abrirIA() { new bootstrap.Modal(document.getElementById('iaModal')).show(); }
        async function consultarIA() {
            const i = document.getElementById('iaQuery'), c = document.getElementById('chatHistory'), p = i.value.trim();
            if(!p) return;
            c.innerHTML += `<div class="chat-msg-user"><span>${p}</span></div>`; i.value = ''; c.scrollTop = c.scrollHeight;
            const lid = "l"+Date.now(); c.innerHTML += `<div id="${lid}" class="text-muted small"><i class="fas fa-spinner fa-spin"></i> Pensando...</div>`;
            try {
                const r = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST", headers: { "Content-Type": "application/json", "Authorization": `Bearer ${GROQ_API_KEY}` },
                    body: JSON.stringify({ model: "llama-3.3-70b-versatile", messages: [{role:"system",content:"Eres Dr. Evidence."}, {role:"user",content:p}] })
                });
                const d = await r.json(); document.getElementById(lid).remove();
                if(d.choices) c.innerHTML += `<div class="chat-msg-ai"><div>${d.choices[0].message.content.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\n/g,'<br>')}</div></div>`;
            } catch(e) { document.getElementById(lid).innerHTML = "Error."; }
            c.scrollTop = c.scrollHeight;
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
